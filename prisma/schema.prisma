// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Authentication & User Management ====================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  firstName         String
  lastName          String
  password          String
  phone             String?
  avatar            String?
  isActive          Boolean   @default(true)
  emailVerified     DateTime?
  lastLogin         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  // Relations
  roles             Role[]
  staffProfile      StaffProfile?
  dentistProfile    DentistProfile?
  sessions          Session[]
  createdCases      Case[]        @relation("CreatedBy")
  assignedCases     Case[]        @relation("AssignedTo")
  caseNotes         CaseNote[]
  conversations     Conversation[]
  conversationParticipants ConversationParticipant[]
  messages          Message[]
  notifications     Notification[]
  auditLogs         AuditLog[]
  schedules         StaffSchedule[]
  reviews           PerformanceReview[]

  @@index([email])
  @@index([isActive])
  @@index([createdAt])
}

model Role {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  users       User[]
  permissions RolePermission[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([name])
}

model Permission {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  roles       RolePermission[]

  @@index([name])
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

// ==================== Case Management ====================

model Case {
  id              String    @id @default(cuid())
  caseNumber      String    @unique
  dentistId       String
  patientName     String
  patientEmail    String?
  patientPhone    String?
  patientDOB      DateTime?
  description     String
  specifications  String?
  priority        CasePriority @default(MEDIUM)
  status          CaseStatus   @default(RECEIVED)
  dueDate         DateTime?
  completedDate   DateTime?
  notes           String?
  createdById     String
  assignedToId    String?
  departmentId    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  dentist         DentistProfile @relation(fields: [dentistId], references: [id])
  createdBy       User       @relation("CreatedBy", fields: [createdById], references: [id])
  assignedTo      User?      @relation("AssignedTo", fields: [assignedToId], references: [id])
  department      Department? @relation(fields: [departmentId], references: [id])
  files           CaseFile[]
  notes_rel       CaseNote[]
  workflowStages  WorkflowStage[]
  appointments    Appointment[]

  @@index([caseNumber])
  @@index([dentistId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([createdAt])
  @@index([assignedToId])
}

enum CaseStatus {
  RECEIVED
  IN_PROGRESS
  COMPLETED
  DELIVERED
  CANCELLED
}

enum CasePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model CaseFile {
  id        String   @id @default(cuid())
  caseId    String
  filename  String
  fileSize  BigInt
  fileType  String
  fileUrl   String
  uploadedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
}

model CaseNote {
  id        String   @id @default(cuid())
  caseId    String
  userId    String
  content   String
  isInternal Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([caseId])
  @@index([userId])
}

// ==================== Workflow Management ====================

model WorkflowStage {
  id          String   @id @default(cuid())
  caseId      String
  stageName   String
  description String?
  sequence    Int
  status      WorkflowStatus @default(PENDING)
  startedAt   DateTime?
  completedAt DateTime?
  assignedTo  String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([status])
}

enum WorkflowStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
  SKIPPED
}

// ==================== Billing & Payments ====================

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  caseId        String
  dentistId     String
  amount        Decimal  @db.Decimal(10, 2)
  tax           Decimal  @db.Decimal(10, 2) @default(0)
  total         Decimal  @db.Decimal(10, 2)
  status        InvoiceStatus @default(DRAFT)
  issuedDate    DateTime @default(now())
  dueDate       DateTime
  paidDate      DateTime?
  description   String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items       InvoiceItem[]
  payments    Payment[]

  @@index([invoiceNumber])
  @@index([status])
  @@index([dueDate])
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model InvoiceItem {
  id        String   @id @default(cuid())
  invoiceId String
  description String
  quantity  Int
  unitPrice Decimal  @db.Decimal(10, 2)
  total     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Payment {
  id          String   @id @default(cuid())
  invoiceId   String
  amount      Decimal  @db.Decimal(10, 2)
  method      PaymentMethod
  reference   String?
  status      PaymentStatus @default(PENDING)
  paidDate    DateTime @default(now())
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([status])
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  CHECK
  CASH
  OTHER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ==================== Inventory Management ====================

model InventoryItem {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  description String?
  category    String
  quantity    Int      @default(0)
  minStock    Int      @default(10)
  maxStock    Int      @default(100)
  unitPrice   Decimal  @db.Decimal(10, 2)
  supplier    String?
  location    String?
  expiryDate  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  transactions InventoryTransaction[]

  @@index([sku])
  @@index([category])
  @@index([quantity])
}

model InventoryTransaction {
  id        String   @id @default(cuid())
  itemId    String
  type      TransactionType
  quantity  Int
  reference String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  item InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([type])
  @@index([createdAt])
}

enum TransactionType {
  PURCHASE
  USAGE
  ADJUSTMENT
  RETURN
  DAMAGE
  EXPIRY
}

model Supplier {
  id          String   @id @default(cuid())
  name        String
  email       String
  phone       String?
  address     String?
  city        String?
  country     String?
  contactPerson String?
  paymentTerms String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
}

// ==================== Staff Management ====================

model StaffProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  employeeId      String    @unique
  department      String
  position        String
  specialization  String?
  hireDate        DateTime
  salary          Decimal   @db.Decimal(12, 2)
  status          EmploymentStatus @default(ACTIVE)
  qualifications  String?
  certifications  String?
  emergencyContact String?
  emergencyPhone  String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedules StaffSchedule[]
  reviews   PerformanceReview[]

  @@index([employeeId])
  @@index([status])
}

enum EmploymentStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED
}

model StaffSchedule {
  id        String   @id @default(cuid())
  staffId   String
  startTime DateTime
  endTime   DateTime
  dayOfWeek Int?
  type      ScheduleType @default(REGULAR)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  staff User @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([startTime])
}

enum ScheduleType {
  REGULAR
  OVERTIME
  LEAVE
  HOLIDAY
}

model PerformanceReview {
  id          String   @id @default(cuid())
  staffId     String
  reviewerId  String
  rating      Int
  comments    String?
  reviewDate  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  staff     StaffProfile @relation(fields: [staffId], references: [id], onDelete: Cascade)
  reviewer  User         @relation(fields: [reviewerId], references: [id])

  @@index([staffId])
  @@index([reviewerId])
}

// ==================== Department Management ====================

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  managerId   String?
  status      DepartmentStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cases      Case[]
  equipment  DepartmentEquipment[]

  @@index([name])
}

enum DepartmentStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

model DepartmentEquipment {
  id              String   @id @default(cuid())
  departmentId    String
  name            String
  model           String?
  serialNumber    String?
  status          EquipmentStatus @default(OPERATIONAL)
  purchaseDate    DateTime
  maintenanceDate DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@index([departmentId])
  @@index([status])
}

enum EquipmentStatus {
  OPERATIONAL
  MAINTENANCE
  REPAIR
  DECOMMISSIONED
}

// ==================== Communications ====================

model Conversation {
  id        String   @id @default(cuid())
  subject   String
  createdById String
  status    ConversationStatus @default(OPEN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdBy     User @relation(fields: [createdById], references: [id])
  participants  ConversationParticipant[]
  messages      Message[]

  @@index([createdById])
  @@index([status])
}

enum ConversationStatus {
  OPEN
  CLOSED
  ARCHIVED
}

model ConversationParticipant {
  id             String   @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime @default(now())
  leftAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  userId         String
  content        String
  attachments    String?
  isEdited       Boolean  @default(false)
  editedAt       DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])

  @@index([conversationId])
  @@index([userId])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  relatedId String?
  isRead    Boolean  @default(false)
  readAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  CASE_ASSIGNED
  CASE_COMPLETED
  PAYMENT_RECEIVED
  INVOICE_ISSUED
  MESSAGE_RECEIVED
  INVENTORY_LOW
  APPOINTMENT_REMINDER
  SCHEDULE_CHANGE
}

// ==================== Dentist Management ====================

model DentistProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  licenseNumber   String    @unique
  specialization  String?
  clinic          String?
  clinicPhone     String?
  clinicEmail     String?
  status          DentistStatus @default(ACTIVE)
  verificationDate DateTime?
  verifiedBy      String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user         User @relation(fields: [userId], references: [id], onDelete: Cascade)
  cases        Case[]
  invoices     Invoice[]
  applications DentistApplication[]

  @@index([licenseNumber])
  @@index([status])
}

enum DentistStatus {
  PENDING_VERIFICATION
  VERIFIED
  SUSPENDED
  INACTIVE
}

model DentistApplication {
  id              String   @id @default(cuid())
  dentistId       String
  status          ApplicationStatus @default(SUBMITTED)
  licenseFile     String?
  certifications  String?
  submittedDate   DateTime @default(now())
  reviewedDate    DateTime?
  reviewedBy      String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  dentist DentistProfile @relation(fields: [dentistId], references: [id], onDelete: Cascade)

  @@index([dentistId])
  @@index([status])
}

enum ApplicationStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
}

// ==================== Appointment & Scheduling ====================

model Appointment {
  id          String   @id @default(cuid())
  caseId      String
  scheduledDate DateTime
  scheduledTime String
  type        AppointmentType
  status      AppointmentStatus @default(SCHEDULED)
  description String?
  location    String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([scheduledDate])
  @@index([status])
}

enum AppointmentType {
  CONSULTATION
  CASE_REVIEW
  DELIVERY
  FOLLOW_UP
  QUALITY_CHECK
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ==================== Logistics & Delivery ====================

model Shipment {
  id              String   @id @default(cuid())
  trackingNumber  String   @unique
  caseId          String
  origin          String
  destination     String
  carrier         String?
  status          ShipmentStatus @default(PENDING)
  estimatedDate   DateTime
  actualDate      DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  deliveryRoutes DeliveryRoute[]

  @@index([trackingNumber])
  @@index([status])
}

enum ShipmentStatus {
  PENDING
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  RETURNED
  CANCELLED
}

model DeliveryRoute {
  id        String   @id @default(cuid())
  shipmentId String
  sequence  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shipment  Shipment     @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  stops     RouteStop[]

  @@index([shipmentId])
}

model RouteStop {
  id        String   @id @default(cuid())
  routeId   String
  location  String
  timestamp DateTime @default(now())
  status    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  route DeliveryRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@index([routeId])
}

// ==================== Settings & Audit ====================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      SettingType @default(STRING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  resource  String
  resourceId String
  changes   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}
